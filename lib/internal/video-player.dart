//   ⠀⠀⠀⢰⠶⣄⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣠⠶⠲⣄⠀
//⠀   ⠀⣠⡟⠀⠈⠙⢦⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⡶⣦⣀⠀⠀⠀⠀⠀⠀⠀⠀⣠⠾⠋⠁⠀⠀⢽⡄
//   ⠀⠀⡿⠀⠀⠀⠀⠀⠉⠷⣄⣀⣤⠤⠤⠤⠤⢤⣷⡀⠙⢷⡄⠀⠀⠀⠀⣠⠞⠉⠀⠀⠀⠀⠀⠈⡇
//   ⠀⢰⡇⠀⠀⠀⠀⠀⠀⠀⠉⠳⣄⠀⠀⠀⠀⠀⠈⠁⠀⠀⠹⣦⠀⣠⡞⠁⠀⠀⠀⠀⠀⠀⠀⠀⡗
//   ⠀⣾⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣻⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣏
//   ⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⡇
//   ⠀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣾⠂
//   ⠀⢿⠀⠀⠀⠀⣤⣤⣤⣀⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣤⣤⣤⣤⣤⡀⠀⠀⠀⠀⠀⣸⠇⠀
//   ⠀⠘⣇⠀⠀⠀⠀⠉⠉⠛⠛⢿⣶⣦⠀⠀⠀⠀⠀⠀⢴⣾⣟⣛⡋⠋⠉⠉⠁⠀⠀⠀⠀⣴⠏⠀⠀
//   ⢀⣀⠙⢷⡄⠀⠀⣀⣤⣶⣾⠿⠋⠁⠀⢴⠶⠶⠄⠀⠀⠉⠙⠻⠿⣿⣷⣶⡄⠀⠀⡴⠾⠛⠛⣹⠇
//   ⢸⡍⠉⠉⠉⠀⠀⠈⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⠀⠀⠀⠀⣬⠷⣆⣠⡤⠄⢀⣤⠞⠁⠀
//   ⠈⠻⣆⡀⠶⢻⣇⡴⠖⠀⠀⠀⣴⡀⣀⡴⠚⠳⠦⣤⣤⠾⠀⠀⠀⠀⠀⠘⠟⠋⠀⠀⠀⢻⣄⠀⠀
//   ⠀⠀⣼⠃⠀⠀⠉⠁⠀⠀⠀⠀⠈⠉⢻⡆⠀⠀⠀⠀⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢻⠀⠀
//   ⠀⢠⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⡀⠀⠀⢀⡇⠀⠀⠀⠀⠀⠀⠀⠀⣀⡿⠧⠿⠿⠟⠀⠀
//   ⠀⣾⡴⠖⠛⠳⢦⣿⣶⣄⣀⠀⠀⠀⠀⠘⢷⣀⠀⣸⠃⠀⠀⠀⣀⣀⣤⠶⠚⠉⠀⠀⠀⠀⠀⠀⠀
//   ⠀⠀⠀⠀⠀⠀⠀⠈⢷⡀⠈⠻⠦⠀⠀⠀⠀⠉⠉⠁⠀⠀⠀⠀⠹⣆⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
//   ⠀⠀⠀⠀⠀⠀⠀⢀⡴⠟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⢳⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀
//   ⠀⠀⠀⠀⠀⢠⡟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠻⡄⠀⠀⠀⠀⠀⠀⠀⠀
//   ⠀⠀⠀⠀⠀⠀⠈⠉⠛⠛⢲⡗⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢻⡆⠀⠀⠀⠀⠀⠀⠀
//   ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡇⠀⠀⠀⠀⠀⠀⠀
//   ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠋⠀⠀⠀⠀⠀⠀⠀
// This app was made by a boykisser - Deal with it >:3
//
import 'dart:io';

import 'package:flutter/material.dart';
import 'package:path_provider/path_provider.dart';
import 'package:http/http.dart' as http;
import 'package:shared_preferences/shared_preferences.dart';
import 'package:video_player/video_player.dart';

import '../inc/features.dart';

class VideoPlayerPage extends StatefulWidget {
  final String videoUrl;

  const VideoPlayerPage({Key? key, required this.videoUrl}) : super(key: key);

  @override
  _VideoPlayerPageState createState() => _VideoPlayerPageState();
}

//⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣀⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
//⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⡤⠔⠚⠉⣵⠧⠐⠒⠒⠠⠤⢤⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
//⠀⠀⠀⠀⠀⠀⠀⣠⠴⠊⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢈⡝⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
//⠀⠀⠀⠀⣠⡔⠋⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣖⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⢄⠀⠀⠀⠀⠀⠀
//⠀⢀⡤⠚⠁⠀⠀⠀⠀⠀⠀⣀⣄⣀⠀⠀⠀⠀⢀⣀⠀⠀⠀⠙⢦⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡄⠙⠒⠀⣀⠀⠀⠀⠀          Just a silly lil peep always watching you
//⠀⠈⢳⣄⠀⠀⠀⠀⠀⢀⡎⢱⣿⣯⣧⠀⠀⠀⢸⡟⠧⠀⠀⠀⠤⢽⡆⠀⠀⠀⠀⠀⣀⣀⣀⣤⣴⠞⢉⣹⣽⢦⠀⠀
//⠀⠀⠺⢥⠀⠀⠀⢀⡾⣤⠆⢸⣿⣿⠏⠀⠀⢠⢼⡇⠀⡠⢀⡀⠀⢀⡵⠀⢀⣤⣾⣿⣿⣿⣿⣿⡇⠀⠈⢚⣐⣿⠠⠀        I'm always watching you
//⠀⠀⠀⠀⠑⠦⢄⣀⣀⠀⠀⠀⣀⡀⠀⠲⡤⡄⣀⣀⠴⠋⣋⣴⣶⣿⣿⣷⣿⣿⣿⣿⣿⣿⣿⣿⣿⣄⠀⢀⡾⠋⠀⠑
//⠀⢀⣀⣤⣄⣀⠀⠀⠿⠤⠴⢺⠉⠉⠀⠀⠉⢻⡛⠒⢲⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡞⠁⠀⠀⠓        I live in your walls
//⡴⠁⠀⠀⠀⠀⠙⢦⡀⠀⠀⡇⠀⠀⡄⠀⠀⠀⢱⣴⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠏⠀⠀⠀⠀⠀
//⡇⠀⠀⠀⠀⠀⠀⠀⢷⠀⠀⢀⠀⠀⣷⠀⠀⠀⢰⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡛⠉⠀⠀⠀⠀⠀⠀⠀
//⠙⠦⣤⣤⣄⠀⠀⠀⠈⡆⠀⢸⠀⠀⢸⠀⠀⠀⡾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣦⡀⠀⠀⠀⠀⠀⠀
//⠀⠀⠀⠀⠀⠑⣄⠀⠀⠹⣄⢸⠀⠀⠘⡄⠀⠀⢷⣹⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠿⣿⡾⠿⠿⠿⣷⠀⠀⠀⠀⠀⠀
//⠀⠀⠀⠀⠀⠹⡄⠀⠀⢈⡟⠀⠀⠀⡇⠀⠀⠈⢷⣝⢿⣿⣿⣿⣿⣿⣿⡿⠋⠀⠀⢠⣷⠀⠀⠀⠸⡇⠀⠀⠀⠀⠀
//⠀⠀⠀⠀⠀⠀⠀⠙⠲⡴⠊⠀⠀⠀⠀⣧⡀⠀⠀⠀⠻⢿⣮⣽⣛⣛⣛⣻⣦⣀⠀⣸⣤⠏⠀⠀⠀⢰⡇⠀⠀⠀⠀⠀
//⠀⠀⠀⠀⠀⠀⠀⠀⢸⡀⡇⠀⡄⠀⠀⣿⠳⣄⠀⠀⠀⠀⠉⠙⠛⠛⠛⠛⠉⣩⡟⠉⠀⠀⠀⠀⣠⠟⠀⠀⠀⠀⠀⠀
//⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⠓⠒⠳⠒⠒⠋⠒⠪⠷⠦⢤⣄⣀⣀⣀⣠⣤⠴⠚⠯⢤⣤⣤⡤⠴⠛⠁⠀⠀⠀⠀⠀⠀⠀

class _VideoPlayerPageState extends State<VideoPlayerPage> {
  late VideoPlayerController _controller;
  bool _isPlaying = false;
  bool _isLoading = true;
  bool _isControlsVisible = true;

  @override
  void initState() {
    super.initState();
    _controller = VideoPlayerController.network(widget.videoUrl)
      ..initialize().then((_) {
        if (mounted) {
          setState(() {
            _isLoading = false;
          });
        }
      });
    _controller.addListener(() {
      if (mounted) {
        setState(() {}); // Update UI when video progresses
        if (_controller.value.position == _controller.value.duration) {
          _showRepeatButton(); // Show repeat button when video finishes
        }
      }
    });
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  String _formatDuration(Duration duration) {
    String twoDigits(int n) => n.toString().padLeft(2, '0');
    final minutes = twoDigits(duration.inMinutes.remainder(60));
    final seconds = twoDigits(duration.inSeconds.remainder(60));
    return '${duration.inHours > 0 ? "${twoDigits(duration.inHours)}:" : ""}$minutes:$seconds';
  }

  void _toggleControlsVisibility() {
    if (mounted) {
      setState(() {
        _isControlsVisible = !_isControlsVisible;
      });
    }
    if (_isControlsVisible) {
      _hideControls();
    }
  }

  void _hideControls() {
    Future.delayed(const Duration(seconds: 3), () {
      if (_isControlsVisible) {
        _toggleControlsVisibility();
      }
    });
  }

  void _showRepeatButton() {
    if (mounted) {
      setState(() {
        // This will trigger a rebuild to show the repeat button
      });
    }
  }

  void _repeatVideo() {
    vibrateSelection();
    if (mounted) {
      setState(() {
        _controller.seekTo(Duration.zero);
        _controller.play();
        _isPlaying = true;
      });
    }
  }

  void _downloadVideo() async {
    final url = widget.videoUrl;
    final response = await http.get(Uri.parse(url));

    if (response.statusCode == 200) {
      final directory = await getApplicationDocumentsDirectory();
      final filePath = '${directory.path}/catkeys_downloaded_video_${DateTime.now().millisecondsSinceEpoch}.mp4';
      final file = File(filePath);
      await file.writeAsBytes(response.bodyBytes);

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Video downloaded to $filePath')),
      );
    } else {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to download video')),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    final mediaQuery = MediaQuery.of(context);
    final screenWidth = mediaQuery.size.width;
    final screenHeight = mediaQuery.size.height;
    final isLandscape = mediaQuery.orientation == Orientation.landscape;
    final videoAspectRatio = _controller.value.aspectRatio;

    double videoWidth;
    double videoHeight;

    if (isLandscape) {
      videoHeight = screenHeight;
      videoWidth = videoHeight * videoAspectRatio;
    } else {
      videoWidth = screenWidth;
      videoHeight = videoWidth / videoAspectRatio;
    }

    return Scaffold(
      backgroundColor: Colors.black87,
      body: Center(
        child: _isLoading
            ? const CircularProgressIndicator()
            : Stack(
                alignment: Alignment.center,
                children: [
                  GestureDetector(
                    onTap: () {
                      _toggleControlsVisibility();
                      _hideControls();
                    },
                    child: SizedBox(
                      width: videoWidth,
                      height: videoHeight,
                      child: VideoPlayer(_controller),
                    ),
                  ),
                  if (_isControlsVisible) ...[
                    _buildTopBar(context),
                    _buildControlsOverlay(),
                  ],
                  if (_controller.value.position == _controller.value.duration)
                    _buildRepeatButton(), // Show repeat button at the end
                ],
              ),
      ),
    );
  }

  Widget _buildTopBar(BuildContext context) {
    return Positioned(
      top: 0,
      left: 0,
      right: 0,
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16.0),
        decoration: BoxDecoration(
          gradient: LinearGradient(
            colors: [Colors.black54, Colors.transparent],
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
          ),
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            IconButton(
              icon: const Icon(Icons.close_rounded, color: Colors.white),
              onPressed: () {
                vibrateSelection();
                Navigator.pop(context); // Close the video page
              },
            ),
            IconButton(
              icon: const Icon(Icons.download_rounded, color: Colors.white),
              onPressed: () async {
                vibrateSelection();

              },
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildControlsOverlay() {
    return Positioned(
      bottom: 0,
      left: 0,
      right: 0,
      child: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            colors: [Colors.black54, Colors.transparent],
            begin: Alignment.bottomCenter,
            end: Alignment.topCenter,
          ),
        ),
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 20.0, vertical: 8.0),
          child: Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              IconButton(
                icon: Icon(
                  _isPlaying ? Icons.pause : Icons.play_arrow,
                  color: Colors.white,
                  size: 32,
                ),
                onPressed: () {
                  vibrateSelection();
                  if (mounted) {
                    setState(() {
                      if (_controller.value.position !=
                          _controller.value.duration) {
                        _isPlaying = !_isPlaying;
                        _isPlaying ? _controller.play() : _controller.pause();
                      }
                    });
                  }
                },
              ),
              Text(
                _formatDuration(_controller.value.position),
                style: const TextStyle(color: Colors.white),
              ),
              SizedBox(width: 8.0), // Spacing between time and progress bar
              Expanded(
                child: VideoProgressIndicator(
                  _controller,
                  allowScrubbing: true,
                  colors: VideoProgressColors(
                    playedColor: Colors.purple,
                    backgroundColor: Colors.grey,
                  ),
                ),
              ),
              SizedBox(width: 8.0), // Spacing between progress bar and time
              Text(
                _formatDuration(_controller.value.duration),
                style: const TextStyle(color: Colors.white),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildRepeatButton() {
    return Positioned(
      bottom: 50, // Adjust position above the controls
      child: IconButton(
        icon: const Icon(Icons.replay, color: Colors.white, size: 48),
        onPressed: _repeatVideo,
      ),
    );
  }
}
